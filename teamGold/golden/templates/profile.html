{% extends "base.html" %}

{% load static %}
{% block head %}
<link rel="stylesheet" href="{% static 'golden/css/global.css' %}">
<link rel="stylesheet" href="{% static 'golden/css/profile.css' %}">
{% endblock %}

{% block content %}
<body>
  <!-- Profile Header -->
  <section class="edit-profile-button">
    <button id="edit-profile-btn" class="nav">
        <img src="{% static 'golden/icons/edit-profile-icon.png' %}"/>
        <span class="sr-only">Edit Profile</span>
    </button>
  </section>

  <!-- Editing Profile Form -->
  <section id="edit-profile-form" style="display:none; margin-top: 1rem;">
    <form method="POST" enctype="multipart/form-data">
      {% csrf_token %}
        
      {{ form.name.label }}<br>
      {{ form.name }}<br><br>

      <label for="profileImage">Profile Picture:</label><br>
      <input type="file" name="profileImage" accept="image/*"><br><br>

      <label for="description">Bio / About Me:</label><br>
      <textarea name="description" rows="4" cols="50" placeholder="Write something about yourself...">
          {{ user.description }}
      </textarea>
      <br><br>

      {{ form.github.label }}<br>
      {{ form.github }}<br><br>

      {{ form.web.label }}<br>
      {{ form.web }}<br><br>

      <button type="submit" name="edit_profile">Save Profile</button>
    </form>
  </section>

  <!-- Profile Description -->
  <section class="description">
    <p class="bio-description">{{ author.description|default:"This user hasn't added a bio yet." }}</p>
  </section>

  <!-- Tab Sections -->
  <section class="tabs-section"> 
    <nav class="tabs">
      <button class="tab-btn active" data-tab="entries">entries</button>
      <button class="tab-btn" data-tab="followers">followers</button>
      <button class="tab-btn" data-tab="following">following</button>
      <button class="tab-btn" data-tab="requests">requests</button>
      <button class="tab-btn" data-tab="search">search</button>
    </nav>

    <section class="tab-panels">

    <!-- Entries Tab Section -->
    <section class="tab-panel active" data-tab-panel="entries">
      {% if entries %}
        {% for entry in entries %}
          <article class="entry">
            <p><strong>@{{ author.username }}</strong> {{ entry.published|date:"H:i T l M d, Y" }}</p>
              {% for img in entry.images.all %} 
                <img src="{{ img.image.url }}" alt="entry image" class="entry-img">
              {% endfor %}
              {{ entry.content|safe }}
          </article>
        {% endfor %}
      {% else %}
        <p>You have no entries yet.</p>
      {% endif %}
    </section>

    <!-- Followers Tab Section -->
    <section class="tab-panel" data-tab-panel="followers">
      {% if followers %}
        {% for f in followers %}
          <section class="author-list-item follower-row">
            <span class="follower-username">{{ f.username }}</span>
            {% if f in friends %}
              <img src="{% static 'golden/icons/friends-icon.png' %}" alt="friend icon" class="friend-icon">
            {% endif %}
          </section>
          <hr class="follower-divider">
        {% endfor %}
      {% else %}
        <p>You're a lonely loser.</p>
      {% endif %}
    </section>

    <!-- Following Tab Section -->
    <section class="tab-panel" data-tab-panel="following">
      {% if following %}
        {% for f in following %}
          <section class="author-list-item follower-row">
            <span class="follower-username">{{ f.username }}</span>
            {% if f in friends %}
              <img src="{% static 'golden/icons/friends-icon.png' %}" alt="friend icon" class="friend-icon">
            {% endif %}

            <form method="POST" class="unfollow-form">
              {% csrf_token %}
              <button type="submit" name="unfollow" value="{{ f.id }}" class="unfollow-btn">
                <img src="{% static 'golden/icons/user-remove-icon.png' %}" alt="unfollow">
              </button>
            </form>
          </section>
          <hr class="follower-divider">
        {% endfor %}
      {% else %}
        <p>Narcassistic Coded.</p>
      {% endif %}
    </section>

    <!-- Request Tab Section -->
    <!-- THIS IS IMPORTANT, PLEASE READ IF YOU ARE REFRACTORING THIS HTML FILE
    The rejection (user-remove-icon & user-add-icon) need to be added in the same way the
    following tab is currently handelling this feature. 
    Comment by: Kenneth
    -->
    <section class="tab-panel" data-tab-panel="requests">
    {% if follow_requests %}
      <ul style="list-style: none; padding: 0;">
        {% for req in follow_requests %}
        <li class="request-row">
          <span>{{ req.actor.username }} wants to follow you</span>
          <div>
            <form method="POST" style="display:inline;">
              {% csrf_token %}
              <input type="hidden" name="follow_id" value="{{ req.id }}">
              <input type="hidden" name="action" value="approve">
              <button class="action-btn approve-btn">Approve</button>
          </form>

          <form method="POST" style="display:inline;">
              {% csrf_token %}
              <input type="hidden" name="follow_id" value="{{ req.id }}">
              <input type="hidden" name="action" value="reject">
              <button class="action-btn reject-btn">Reject</button>
          </form>
          </div>
        </li>
        {% endfor %}
      </ul>
    {% else %}
      <p>You have no outgoing following requests.</p>
    {% endif %}
    </section>

    <!-- Search Tab Section -->
    <!-- THIS IS IMPORTANT TO PLEASE READ IF YOU ARE REFRACTORING THIS HTML FILE
    When you click this tab, you are suppose to see everyone immediately, you should not 
    need to type in the username to see the users, because what if they don't even know 
    what they're looking for eh?
    Comment by: Kenneth
    -->
    <section class="tab-panel" data-tab-panel="search">
      <form method="GET" action="">      
        <input type="text" name="q" class="search-bar" placeholder="Search by username" value="{{ query }}"
          style="flex: 1; padding: 0 20px; font-size: 1rem; box-sizing: border-box; height: 100%;
                 border: 1px solid #555; background: var(--colour-off-background); color: var(--colour-contrast);
                        border-radius: 6px;">
          <button type="submit" 
                  style="flex-shrink: 0; padding: 0 20px; font-size: 1rem; border: 2px solid #000;
                        background: var(--colour-yellow); color: #000; border-radius: 6px; cursor: pointer; height: 100%;
                        font-weight: 600;">
              Search
          </button>
      </form>

      <div class="author-list">
          {% if authors %}
              <ul style="list-style: none; padding: 0;">
                  {% for author in authors %}
                      {% if author != request.user %}
                          <li class="author-row" 
                              style="display: flex; justify-content: space-between; align-items: center;
                                    background: var(--colour-off-background); border: 1px solid #333; 
                                    border-radius: 6px; padding: 10px 15px; margin-bottom: 8px;
                                    color: var(--colour-contrast); transition: background 0.2s ease;">
                              <span>{{ author.username }}</span>

                              <form method="POST" action="{% url 'search_authors' %}" style="display:inline;">
                                  {% csrf_token %}
                                  <input type="hidden" name="author_id" value="{{ author.id }}">
                                  {% if author.follow_state == "REQUESTED" %}
                                      <button class="follow-btn" disabled>Requested</button>
                                  {% elif author.follow_state == "ACCEPTED" %}
                                      <button class="follow-btn" disabled>Following</button>
                                  {% else %}
                                      <button class="follow-btn">Follow</button>
                                  {% endif %}
                              </form>
                          </li>
                      {% endif %}
                  {% endfor %}
              </ul>
          {% else %}
              <p style="color: var(--text-muted);">No authors found.</p>
          {% endif %}
      </div>
    </section>
    </section>
  </section>
</body>

<script>
// Edit Profile Form Toggle 
document.getElementById('edit-profile-btn').addEventListener('click', function() {
    const form = document.getElementById('edit-profile-form');
    form.style.display = form.style.display === 'none' ? 'block' : 'none';
});

// Tab Switching
document.addEventListener("DOMContentLoaded", () => {
  const tabButtons = document.querySelectorAll(".tab-btn");
  const tabPanels = document.querySelectorAll(".tab-panel");

  tabButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      const target = btn.dataset.tab;
      const targetPanel = document.querySelector(`[data-tab-panel="${target}"]`);

      tabButtons.forEach(b => b.classList.remove("active"));
      tabPanels.forEach(p => p.classList.remove("active"));

      btn.classList.add("active");
      if (targetPanel) targetPanel.classList.add("active");
    });
  });
});
</script>
{% endblock %}
