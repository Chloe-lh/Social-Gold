{% extends "base.html" %}

{% load static %}
{% block head %}
<link rel="stylesheet" href="{% static 'golden/css/global.css' %}">
<link rel="stylesheet" href="{% static 'golden/css/profile.css' %}">
<link rel="stylesheet" href="{% static 'golden/css/mobile-profile.css' %}">
{% endblock %}

{% block content %}
<body>
  <!-- Profile Header -->
  <section class="edit-profile-button">
    <button id="edit-profile-button" class="nav" type="button" aria-label="Edit profile button">
      <img src="{% static 'golden/icons/edit-profile-icon.png' %}" alt="" aria-hidden="true"/>
    </button>
  </section>

  <!-- Editing Profile Form -->
  <section id="edit-profile-form" style="display:none; margin-top: 1rem;">
    <form method="POST" enctype="multipart/form-data">
      {% csrf_token %}
        
      {{ form.name.label }}<br>
      {{ form.name }}<br><br>

      <label for="profileImage">Profile Picture:</label><br>
      <input type="file" name="profileImage" accept="image/*"><br><br>

      <label for="description">Bio / About Me:</label><br>
      <textarea name="description" rows="4" cols="50">
        {{ user.description }}
      </textarea>
      <br><br>

      {{ form.github.label }}<br>
      {{ form.github }}<br><br>

      {{ form.web.label }}<br>
      {{ form.web }}<br><br>

      <button type="submit" name="edit_profile">Save Profile</button>
    </form>
  </section>

  <!-- Profile Description -->
  <section class="description">
    <p class="bio-description">{{ author.description|default:"This user does not have a bio."|safe }}</p>
  </section>

  <!-- Tab Sections -->
  <section class="tabs-section"> 
    <nav class="tabs">
      <button class="tab-btn active" data-tab="entries">entries</button> 
      <button class="tab-btn" data-tab="followers">followers</button>
      <button class="tab-btn" data-tab="following">following</button>
      <button class="tab-btn" data-tab="requests">requests</button>
      <button class="tab-btn" data-tab="search">search</button>
    </nav>

    <!-- Entries Tab Section -->
    <section class="tab-panel active" data-tab-panel="entries">
      {% if entries %}
        {% for entry in entries %}
          <article class="entry">
            <p><strong>@{{ author.username }}</strong> {{ entry.published|date:"H:i T l M d, Y" }}</p>
            {% for img in entry.images.all %} 
              <img src="{{ img.image.url }}" alt="entry image" class="entry-img">
            {% endfor %}
            {{ entry.content|safe }}
          </article>
        {% endfor %}
      {% else %}
        <p>You have no entries, consider posting your first one!</p>
      {% endif %}
    </section>

    <!-- Followers Tab Section -->
    <section class="tab-panel" data-tab-panel="followers">
      {% if followers %}
        {% for f in followers %}
          <section class="author-list-item follower-row">
            <a href="{% url 'public-profile' f.id %}" class="follower-username">{{ f.username }}</a>
            {% if f in friends %}
              <img class="friend-icon" src="{% static 'golden/icons/friends-icon.png' %}" alt="you are friends" title="You are friends!">
            {% endif %}
          </section>
          <hr class="follower-divider">
        {% endfor %}
      {% else %}
        <p>You have no followers.</p>
      {% endif %}
    </section>

    <!-- Following Tab Section -->
    <section class="tab-panel" data-tab-panel="following">
      {% if following %}
        {% for f in following %}
          <section class="author-list-item follower-row">
            <a href="{% url 'public-profile' f.id %}" class="follower-username">{{ f.username }}</a>
            {% if f in friends %}
              <img class="friend-icon" src="{% static 'golden/icons/friends-icon.png' %}" alt="you are friends" title="You are friends!">
            {% endif %}

            <form method="POST" class="unfollow-form">
              {% csrf_token %}
              <button type="submit" name="unfollow" value="{{ f.id }}" class="unfollow-btn">
                <img src="{% static 'golden/icons/user-remove-icon.png' %}" alt="unfollow this person">
              </button>
            </form>
          </section>
          <hr class="follower-divider">
        {% endfor %}
      {% else %}
        <p>You are not following anyone.</p>
      {% endif %}
    </section>

    <!-- Request Tab Section -->
    <section class="tab-panel" data-tab-panel="requests">
    {% if follow_requests %}
      <ul style="list-style: none; padding: 0;">
        {% for req in follow_requests %}
        <li class="request-row">
          <a href="{% url 'public-profile' req.actor.id %}">{{ req.actor.username }} wants to follow you</span>
            <form method="POST" style="display:inline;">
              {% csrf_token %}
              <input type="hidden" name="follow_id" value="{{ req.id }}">
              <input type="hidden" name="action" value="approve">
              <button class="action-btn approve-request-button" type="submit">
                  <img src="{% static 'golden/icons/user-add-icon.png' %}" alt="approve">
              </button>
            </form>
        
            <form method="POST" style="display:inline;">
            {% csrf_token %}
              <input type="hidden" name="follow_id" value="{{ req.id }}">
              <input type="hidden" name="action" value="reject">
              <button class="action-btn reject-request-button" type="submit">
                  <img src="{% static 'golden/icons/user-remove-icon.png' %}" alt="reject">
              </button>
            </form>
        </li>
        {% endfor %}
        <hr class="follower-divider">
      </ul>
    {% else %}
      <p>You have no outgoing following requests.</p>
    {% endif %}
    </section>

    <!-- Search Tab Section -->
    <section class="tab-panel" data-tab-panel="search">

      <!-- Search Bar Feature -->
      <form method="GET" action="">
        <input type="text" name="q" placeholder="Search users..." ="{{ query }}" class="search-bar">
        <button type="submit"> Search for User </button>
      </form>

      <!-- Author List Feature -->
      {% if authors %}
      <ul>
      {% for a in authors %}
        <li style="padding: 10px; border-bottom: 1px solid #ccc; display: flex; justify-content: space-between; align-items: center;">
          <a href="{% url 'public-profile' a.id %}">{{ a.username }}</a>

          {% if a.is_friend %}
            <button class="follow-btn" disabled>
              <img src="{% static 'golden/icons/friends-icon.png' %}" alt="you are friends" title="You are friends!">
            </button>

          {% elif a.follow_state == "REQUESTED" %}
            <button class="follow-btn" disabled>
              <img src="{% static 'golden/icons/user-loading-icon.png' %}" alt="pending" title="Author needs to accept you silly."> 
            </button>

          {% elif a.follow_state == "ACCEPTED" %}
            <button class="follow-btn" disabled>
              <img src="{% static 'golden/icons/user-following-icon.png' %}" alt="following" title="You follow this author">
            </button>

          {% else %}
            <form method="POST">
              {% csrf_token %}
              <input type="hidden" name="action" value="follow">
              <input type="hidden" name="author_id" value="{{ a.id }}">
              <input type="hidden" name="author_username" value="{{ a.username }}">
              <input type="hidden" name="author_is_local" value="{{ a.is_local }}">
              <input type="hidden" name="author_displayName" value="{{ a.displayName }}">
              <input type="hidden" name="author_profileImage" value="{{ a.profileImage }}">
              <input type="hidden" name="author_github" value="{{ a.github }}">
              <input type="hidden" name="author_web" value="{{ a.web }}">
              <button class="follow-btn" type="submit">
                <img src="{% static 'golden/icons/user-add-icon.png' %}" alt="follow">
              </button>
            </form>
          {% endif %}
        </li>
      {% endfor %}
      </ul>
    {% else %}
      <p>No authors found.</p>
    {% endif %} 
  </section>
</body>

<script>
// Edit Profile Form Toggle 
document.getElementById('edit-profile-button').addEventListener('click', function() {
    const form = document.getElementById('edit-profile-form');
    form.style.display = form.style.display === 'none' ? 'block' : 'none';
});

// Store active tab in sessionStorage when tab is clicked
document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll(".tab-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      sessionStorage.setItem("activeTab", btn.dataset.tab);
    });
  });

  // Apply active tab from sessionStorage
  const saved = sessionStorage.getItem("activeTab");
  if (saved) {
    const btn = document.querySelector(`[data-tab="${saved}"]`);
    const panel = document.querySelector(`[data-tab-panel="${saved}"]`);

    if (btn && panel) {
      document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
      document.querySelectorAll(".tab-panel").forEach(p => p.classList.remove("active"));

      btn.classList.add("active");
      panel.classList.add("active");
    }
  }
});

// Tab Switching
document.addEventListener("DOMContentLoaded", () => {
  const tabButtons = document.querySelectorAll(".tab-btn");
  const tabPanels = document.querySelectorAll(".tab-panel");

  tabButtons.forEach(button => {
    button.addEventListener("click", () => {
      const target = button.dataset.tab;
      const targetPanel = document.querySelector(`[data-tab-panel="${target}"]`);

      tabButtons.forEach(button => button.classList.remove("active"));
      tabPanels.forEach(panel => panel.classList.remove("active"));

      button.classList.add("active");
      if (targetPanel) {
        targetPanel.classList.add("active");
      }
    });
  });
});
</script>
{% endblock %}
