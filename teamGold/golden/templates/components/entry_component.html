{% load static %}

<a href="{% url 'entry_detail' entry_uuid=entry.get_uuid %}" class="entry-link">
<article data-entry-id="{{ entry.id }}" class="entry">

    <!-- Entry Header Section -->
    <header class="article-header">
      <a href="{% url 'public-profile' entry.author.uuid_only %}">{{ entry.author }}</a>

        <span class="visibility-badge" data-visibility="{{ entry.visibility }}">
        {% if entry.visibility == "PUBLIC" %}
            <img src="{% static 'golden/icons/entry-all-icon.png' %}" alt="Public">
        {% elif entry.visibility == "UNLISTED" %}
            <img src="{% static 'golden/icons/entry-unlisted-icon.png' %}" alt="Unlisted">
        {% elif entry.visibility == "FRIENDS" %}
            <img src="{% static 'golden/icons/friends-icon.png' %}" alt="Friends">
        {% endif %}
        </span>

        <p>{{ entry.published|date:"Y-m-d H:i" }}</p>

        {% if entry.is_updated and entry.is_updated != entry.published %}
        <p class="updated-footer">
            Edited: {{ entry.is_updated|date:"Y-m-d H:i" }}
        </p>
        {% endif %}
    </header>

    <!-- Entry Content -->
    <section class="entry-body">
        {% if entry.title %}
        <h3>{{ entry.title }}</h3>
        {% endif %}

        <div style="display:flex;">
        {% for img_url in entry.get_all_images|slice:":2" %}
            <img src="{{ img_url }}" alt="Entry image" class="entry-image">
        {% endfor %}
        </div>

        {{ entry.content|safe }}
    </section>

    <!-- Entry Footer -->
    <footer style="padding-top:5px;">

        <form method="post" action="{% url 'add_like' %}" style="display:inline">
        {% csrf_token %}
        <input type="hidden" name="object" value="{{ entry.id }}">
        <button type="submit" class="like-btn">
            <img src="{% static 'golden/icons/like-icon.png' %}">
            <span>{{ entry.likes.count }} Stars</span>
        </button>
        </form>

        <button class="comment-btn"
        data-entry-id="{{ entry.id }}"
        data-entry-url="{% url 'entry_detail' entry.get_uuid %}">
        <img src="{% static 'golden/icons/comment-icon.png' %}">
        <span>{{ entry.comment.count }} Comments</span>
        </button>

        <button class="share-btn"
        data-entry-url="{% url 'entry_detail' entry.get_uuid %}">
        <img src="{% static 'golden/icons/share-icon.png' %}">
        </button>
    </footer><br>
</article>
</a>

<script>
    const entries = document.querySelectorAll(".entry");

    entries.forEach(function(entry) {
        entry.addEventListener("click", function(e) {
            // Prevent clicks on buttons or images from triggering navigation
            if (
                e.target.closest("button") ||
                e.target.tagName === "IMG" ||
                e.target.closest("a")
            ) return;

            const fqid = entry.dataset.entryId; // e.g., https://node1.com/api/entries/7125b60a-f900-4a10-906e-94f974bb85ff
            const uuid = fqid.split("/").pop(); // get only the UUID
            const localUrl = `/golden/entry/${uuid}/`; // build local URL

            window.location.href = localUrl;
        });
    });

    document.querySelectorAll('.share-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
        e.stopPropagation();

        // Get the URL for this entry
        const entryUrl = this.dataset.entryUrl;
        const fullUrl = window.location.origin + entryUrl;

        // Copy to clipboard
        navigator.clipboard.writeText(fullUrl).then(() => {
            // Optional: small confirmation popup
            alert("Link copied to clipboard!");
            }).catch(err => {
            console.error("Failed to copy link:", err);
            });
        });
    });
</script>